<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Avaliação Pré‑Quimioterapia – PDF Tabelado</title>
  <!-- jsPDF e AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #fff;
    }
    .container {
      max-width: 740px;
      margin: auto;
    }
    form .campo {
      margin-bottom: 12px;
    }
    form .campo label {
      display: block;
      font-weight: bold;
      margin-bottom: 4px;
    }
    form .campo input,
    form .campo select,
    form .campo textarea {
      width: 100%;
      padding: 6px;
      font-size: 14px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    form .campo textarea {
      resize: vertical;
      min-height: 40px;
    }
    button {
      margin-top: 20px;
      padding: 10px 24px;
      background: #007bff;
      color: #fff;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Formulário de Avaliação Pré‑Quimioterapia</h2>
    <form id="formQuimio">
      <!-- Exemplo reduzido de campos; ideal você incluir todos -->
      <div class="campo">
        <label for="Paciente_ID">Paciente_ID</label>
        <input type="text" id="Paciente_ID" name="Paciente_ID" required>
      </div>
      <div class="campo">
        <label for="Nome_Completo">Nome Completo</label>
        <input type="text" id="Nome_Completo" name="Nome_Completo">
      </div>
      <div class="campo">
        <label for="Sexo">Sexo (M/F)</label>
        <select id="Sexo" name="Sexo">
          <option value="">Selecione</option>
          <option value="M">M</option>
          <option value="F">F</option>
        </select>
      </div>
      <div class="campo">
        <label for="Peso_kg">Peso (kg)</label>
        <input type="number" id="Peso_kg" name="Peso_kg" step="0.1">
      </div>
      <div class="campo">
        <label for="Altura_cm">Altura (cm)</label>
        <input type="number" id="Altura_cm" name="Altura_cm" step="0.1">
      </div>
      <div class="campo">
        <label for="SC_m2">SC (m²)</label>
        <input type="number" id="SC_m2" name="SC_m2" step="0.01" readonly>
      </div>

      <!-- demais campos... -->
      <div class="campo">
        <label for="LDH_valor">LDH Valor</label>
        <input type="text" id="LDH_valor" name="LDH_valor">
      </div>
      <div class="campo">
        <label for="Albumina_valor">Albumina Valor</label>
        <input type="text" id="Albumina_valor" name="Albumina_valor">
      </div>

      <h3>ECG</h3>
      <div class="campo">
        <label for="ECG_frequencia">Frequência cardíaca (bpm)</label>
        <input type="number" id="ECG_frequencia" name="ECG_frequencia">
      </div>
      <div class="campo">
        <label>Ritmo</label>
        <div>
          <label><input type="radio" name="ECG_ritmo" value="Sinusal"> Sinusal</label>
          <label><input type="radio" name="ECG_ritmo" value="Outro"> Outro:</label>
          <input type="text" id="ECG_ritmo_outro" name="ECG_ritmo_outro" placeholder="Descreva se outro">
        </div>
      </div>
      <div class="campo">
        <label for="ECG_QTc">Intervalo QTc (ms)</label>
        <input type="text" id="ECG_QTc" name="ECG_QTc">
      </div>

      <h3>ECOcardiograma</h3>
      <div class="campo">
        <label for="ECO_FE">Fração de ejeção (FE) (%)</label>
        <input type="text" id="ECO_FE" name="ECO_FE">
      </div>
      <div class="campo">
        <label>Função sistólica</label>
        <select id="ECO_sistolica" name="ECO_sistolica">
          <option value="">Selecione</option>
          <option value="Normal">Normal</option>
          <option value="Alterada">Alterada</option>
        </select>
      </div>
      <div class="campo">
        <label>Função diastólica</label>
        <select id="ECO_diastolica" name="ECO_diastolica">
          <option value="">Selecione</option>
          <option value="Normal">Normal</option>
          <option value="Alterada">Alterada</option>
        </select>
      </div>

      <div class="campo">
        <label for="Observacoes">Observações</label>
        <textarea id="Observacoes" name="Observacoes"></textarea>
      </div>

      <button type="submit">Gerar PDF Tabelado</button>
    </form>
  </div>

  <script>
    // cálculo automático da SC
    function calcularSC() {
      const peso = parseFloat(document.getElementById('Peso_kg').value);
      const altura = parseFloat(document.getElementById('Altura_cm').value);
      if (!isNaN(peso) && !isNaN(altura)) {
        const sc = 0.007184 * Math.pow(peso, 0.425) * Math.pow(altura, 0.725);
        document.getElementById('SC_m2').value = sc.toFixed(2);
      } else {
        document.getElementById('SC_m2').value = '';
      }
    }
    document.getElementById('Peso_kg').addEventListener('input', calcularSC);
    document.getElementById('Altura_cm').addEventListener('input', calcularSC);

    document.getElementById('formQuimio').addEventListener('submit', function(event) {
      event.preventDefault();
      const form = event.target;

      // coletar dados do formulário de forma genérica
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      // determinar ritmo selecionado
      const ritmoSelecionado = form.querySelector('input[name="ECG_ritmo"]:checked');
      data.ECG_ritmo = ritmoSelecionado
        ? (ritmoSelecionado.value === "Outro"
            ? (form.ECG_ritmo_outro.value.trim() || "Outro")
            : ritmoSelecionado.value)
        : "";

      // garante que campos numéricos sejam apresentados de forma amigável
      ["Peso_kg", "Altura_cm", "SC_m2", "ECG_frequencia"].forEach((campo) => {
        if (data[campo]) {
          const numero = Number(data[campo].replace(',', '.'));
          if (!Number.isNaN(numero)) {
            data[campo] = numero.toString().replace('.', ',');
          }
        }
      });

      // gerar PDF com layout tabelado
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });

      const margin = 40;
      const pageWidth = doc.internal.pageSize.width;
      const pageHeight = doc.internal.pageSize.height;
      const usableWidth = pageWidth - margin * 2;
      let y = margin;

      // inserir logo no topo
      const logoUrl = "https://vidahematologia.com.br/wp-content/uploads/2025/02/vida-hematologia-logo.png";
      const logoWidth = 120;
      const logoHeight = 60;

      // função auxiliar para carregar a imagem
      function loadImage(url) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.crossOrigin = "Anonymous";
          img.src = url;
          img.onload = () => resolve(img);
          img.onerror = reject;
        });
      }

      const filtrarCampos = (entradas) =>
        entradas.filter(([, valor]) => valor && valor.toString().trim() !== "");

      const adicionarOuMensagem = (config) => {
        doc.setFont(undefined, 'bold');
        doc.text(config.titulo, margin, y);
        y += 18;
        doc.setFont(undefined, 'normal');

        if (config.linhas.length > 0) {
          doc.autoTable({
            startY: y,
            margin: { left: margin, right: margin },
            tableWidth: usableWidth,
            theme: 'grid',
            styles: { fontSize: 10, cellPadding: 4 },
            head: [config.cabecalho],
            body: config.linhas
          });
          y = doc.lastAutoTable.finalY + 20;
        } else {
          doc.text("Sem dados informados.", margin, y);
          y += 20;
        }
      };

      (async () => {
        try {
          const img = await loadImage(logoUrl);
          doc.addImage(img, 'PNG', margin, margin, logoWidth, logoHeight);
        } catch (err) {
          // falhou carregar logo, ignora
        }

        y = margin + logoHeight + 20;

        doc.setFontSize(16);
        doc.text("Ficha de Avaliação Pré‑Quimioterapia", margin, y);
        y += 25;

        doc.setFontSize(12);

        const secoes = [
          {
            titulo: "Identificação e Dados Demográficos",
            cabecalho: ['Campo', 'Valor'],
            linhas: filtrarCampos([
              ["Paciente_ID", data.Paciente_ID],
              ["Nome Completo", data.Nome_Completo],
              ["Sexo", data.Sexo],
              ["Peso (kg)", data.Peso_kg],
              ["Altura (cm)", data.Altura_cm],
              ["SC (m²)", data.SC_m2]
            ])
          },
          {
            titulo: "Exames Laboratoriais",
            cabecalho: ['Exame', 'Valor'],
            linhas: filtrarCampos([
              ["LDH", data.LDH_valor],
              ["Albumina", data.Albumina_valor]
            ])
          },
          {
            titulo: "ECG",
            cabecalho: ['Parâmetro', 'Valor'],
            linhas: filtrarCampos([
              ["Frequência (bpm)", data.ECG_frequencia],
              ["Ritmo", data.ECG_ritmo],
              ["QTc (ms)", data.ECG_QTc]
            ])
          },
          {
            titulo: "ECOcardiograma",
            cabecalho: ['Parâmetro', 'Valor'],
            linhas: filtrarCampos([
              ["Fração de Ejeção (%)", data.ECO_FE],
              ["Função Sistólica", data.ECO_sistolica],
              ["Função Diastólica", data.ECO_diastolica]
            ])
          }
        ];

        for (const secao of secoes) {
          if (y + 40 > pageHeight - margin) {
            doc.addPage();
            y = margin;
          }
          adicionarOuMensagem(secao);
        }

        if (y + 60 > pageHeight - margin) {
          doc.addPage();
          y = margin;
        }

        // seção Observações / assinatura
        doc.setFont(undefined, 'bold');
        doc.text("Observações", margin, y);
        y += 18;
        doc.setFont(undefined, 'normal');
        const obs = data.Observacoes ? data.Observacoes.trim() : "";
        if (obs) {
          const obsLines = doc.splitTextToSize(obs, usableWidth);
          doc.text(obsLines, margin, y);
          y += obsLines.length * 14 + 20;
        } else {
          doc.text("Sem observações adicionais.", margin, y);
          y += 20;
        }

        // rodapé
        doc.setFontSize(10);
        const hoje = new Date();
        doc.text(`Gerado em: ${hoje.toLocaleString()}`, margin, pageHeight - margin);

        // salvar PDF
        doc.save("Ficha_Avaliacao_Quimioterapia_Tabelada.pdf");
      })();
    });
  </script>
</body>
</html>
